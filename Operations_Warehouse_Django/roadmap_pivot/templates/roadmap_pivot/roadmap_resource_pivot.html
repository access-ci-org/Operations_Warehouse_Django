{% extends "base_detail.html" %}
{% load pivot_filters %}

{% block title %}Resource Badge Status by Roadmap{% endblock %}

{% block content %}

<div class="container-fluid px-5">

<div class="text-center mb-4">
    <h2>Resource Badge Status by Roadmap</h2>
    <p class="mb-0"><strong>Badge verification status for all resources organized by roadmap</strong> <br />
    Required Badge: <span class="text-danger">*</span></p>
</div>

<ul class="nav nav-tabs justify-content-center mb-4">
{% for roadmap in roadmaps %}
    <li class="nav-item">
        {% if selected_roadmap == roadmap.roadmap_id %}
        <a class="nav-link active" aria-current="page" href="#">
        {% else %}
        <a class="nav-link" href="?roadmap={{ roadmap.roadmap_id }}">
        {% endif %}
        {{ roadmap.name }}</a>
    </li>
{% endfor %}
</ul>

<div class="table-responsive">
    <table class="table table-bordered table-hover table-sm">
    <thead>
        <tr>
        <th class="text-center">Badge Not Planned</th>
        <th class="text-center">Badge is Planned <br />Not yet functional</th>
        <th class="text-center">Badge is Verified</th>
        <th class="text-center">Issue with Badge <br />Not yet functional</th>
        <th class="text-center">Badge is Retired <br />Not functional</th>
        </tr>
    </thead>
    <tbody>
        <tr>
        <td class="text-center">-</td>
        <td class="text-center fs-5" style="color: gray;">&#x2714;</td>
        <td class="text-center text-success fs-4">&#x2714;</td>
        <td class="text-center fs-5" style="color: gray;">&#x2714;</td>
        <td class="text-center">-</td>
        </tr>
    </tbody>
    </table>
</div>

{% if is_preproduction_tab %}
    <div class="alert alert-info">
        <h4><i class="fas fa-info-circle"></i> Pre-Production Resources</h4>
        <p class="mb-0">These resources are not yet in production status (pre-production, coming soon, etc.).</p>
    </div>

    {% if preproduction_resources %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-primary">
                    <tr>
                        <th class="text-center" style="width: 50%;">Resource</th>
                        <th class="text-center" style="width: 25%;">Status</th>
                        <th class="text-center" style="width: 25%;">Status Begin</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resource in preproduction_resources %}
                    <tr class="{% if resource.fixed_status == 'pre-production' %}table-info{% elif resource.fixed_status == 'coming soon' %}table-warning{% endif %}">
                        <td class="text-center fs-5">
                            <strong>{{ resource.resource_info.resource_descriptive_name }}</strong>
                            <br/>
                            <small>{{ resource.resource_info.info_resourceid }}</small>
                        </td>
                        <td class="text-center">
                            <span class="badge {% if resource.fixed_status == 'pre-production' %}bg-info text-dark{% elif resource.fixed_status == 'coming soon' %}bg-warning text-dark{% else %}bg-light text-dark{% endif %}">
                                {{ resource.fixed_status|title }}
                            </span>
                        </td>
                        <td class="text-center">{{ resource.latest_status_begin|date:"M d, Y"|default:"—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-success">
            <h4><i class="fas fa-check-circle"></i> No Pre-Production Resources</h4>
            <p class="mb-0">All resources are either in production status or have moved beyond pre-production.</p>
        </div>
    {% endif %}

{% elif selected_roadmap %}

    {% if required_percentage > 0 %}
    <div class="text-center mb-4">
        <div class="card d-inline-block">
            <div class="card-body py-2 px-4">
                <h2 class="mb-0">
                    <span class="text-primary-emphasis">{{ required_percentage }}</span><strong>%</strong> of required badges verified
                </h2>
            </div>
        </div>
    </div>
    {% endif %}

    {% if pivot_data %}
        <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-warning">
                    <tr>
                        <th class="text-center" style="width: 15%;">Resource</th>
                        <th class="text-center" style="width: 8%;">Fixed Status</th>
                        <th class="text-center" style="width: 10%;">Status Begin</th>

                        <!-- ALL badges -->
                        {% for badge in badges_list %}
                        <th class="text-center" style="min-width: 80px; max-width: 130px;">
                            <div style="word-break: normal; overflow-wrap: break-word; hyphens: auto;">
                                {{ badge.badge.name }}
                                {% if badge.required %}<span class="text-danger">*</span>{% endif %}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>

                <tbody>
                    {% for resource_id, resource_data in pivot_data.items %}
                    <tr>
                        <td class="text-center fs-5">
                            <strong>{{ resource_data.resource_info.resource_descriptive_name }}</strong><br/>
                            <small>{{ resource_data.resource_info.info_resourceid }}</small>
                        </td>

                        <td class="text-center">{{ resource_data.fixed_status|default:"—" }}</td>
                        <td class="text-center">{{ resource_data.latest_status_begin|date:"M d, Y"|default:"—" }}</td>

                        <!-- ALL badge columns -->
                        {% for badge in badges_list %}
                        {% with badge_status=resource_data.badge_statuses|get_item:badge.id %}
                        <td class="text-center{% if badge_status == 'verified' %} text-success fs-4{% elif badge_status == 'planned' or badge_status == 'verification_failed' %} fs-5{% elif badge_status %} table-warning{% endif %}"
                           {% if badge_status == 'planned' or badge_status == 'verification_failed' %}style="color: gray;"{% endif %}>


                            {% if badge_status == 'verified' %}&#x2714;
                            {% elif badge_status == 'planned' %}&#x2714;
                            {% elif badge_status == 'verification_failed' %}&#x2714;
                            {% elif badge_status == 'retired' %}-
                            {% elif badge_status %}<!-- Other issues -->
                            {% else %}<span class="text-muted">-</span>
                            {% endif %}

                        </td>
                        {% endwith %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-warning">
            <h4><i class="fas fa-exclamation-triangle"></i> No Resources Found</h4>
            <p class="mb-0">No resources are associated with this roadmap or no resources have badge statuses assigned.</p>
        </div>
    {% endif %}
{% else %}
    <div class="alert alert-info">
        <h4><i class="fas fa-info-circle"></i> No Roadmap Selected</h4>
        <p class="mb-0">Please select a roadmap from the tabs above to view the resource badge status.</p>
    </div>
{% endif %}

</div>
{% endblock %}
